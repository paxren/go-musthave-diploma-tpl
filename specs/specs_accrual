 
Система расчёта вознаграждений «Гофермарт» (accrual)
Общие требования
Система представляет собой HTTP API со следующими требованиями к бизнес-логике:

    регистрация новых механик вознаграждений;
    приём номеров заказов от доверенного источника для расчёта вознаграждений;
    проведение расчёта вознаграждений за заказы;
    выдача информации о проведённом расчёте вознаграждений за заказ.

Сводное HTTP API системы расчёта баллов лояльности
Системы расчёта баллов лояльности должна предоставлять следующие HTTP-хендлеры:

    GET /api/orders/{number} — получение информации о расчёте начислений баллов лояльности;
    POST /api/orders — регистрация нового совершённого заказа;
    POST /api/goods — регистрация информации о новой механике вознаграждения за товар.

Общие ограничения и требования

    хранилище данных — PostgreSQL;
    структура таблиц остаётся на усмотрение студента;
    типы и формат хранения данных (в том числе паролей и прочей чувствительной информации) остаются на усмотрение студента;
    клиент может поддерживать HTTP-запросы/ответы со сжатием данных;
    клиент не обязан делать запросы соответственно нижеизложенной спецификации API, любая проверка запроса остаётся на усмотрение студента;
    аутентификации запросов не требуется;
    номера заказов уникальны и никогда не повторяются;
    номер заказа может быть принят в обработку только один раз;
    номер заказа может не иметь никакого начисления.

Получение информации о расчёте начислений
Хендлер: GET /api/orders/{number}.
Получение информации о расчёте начислений баллов лояльности за совершённый заказ.
Номером заказа является последовательность цифр произвольной длины. Номер заказа может быть проверен на корректность ввода с помощью алгоритма Луна.
Формат запроса:

GET /api/orders/{number} HTTP/1.1
Content-Length: 0

Возможные коды ответа:

    200 — успешная обработка запроса.
      Формат ответа:

  200 OK HTTP/1.1
  Content-Type: application/json
  ...

  {
      "order": "<number>",
      "status": "PROCESSED",
      "accrual": 500
  }


  Поля объекта ответа:

    order — номер заказа;
    status — статус расчёта начисления:
        REGISTERED — заказ зарегистрирован, но не начисление не рассчитано;
        INVALID — заказ не принят к расчёту, и вознаграждение не будет начислено;
        PROCESSING — расчёт начисления в процессе;
        PROCESSED — расчёт начисления окончен;
    accrual — рассчитанные баллы к начислению, при отсутствии начисления — поле отсутствует в ответе.

204 — заказ не зарегистрирован в системе расчёта.
429 — превышено количество запросов к сервису.
  Формат ответа:

  429 Too Many Requests HTTP/1.1
  Content-Type: text/plain
  Retry-After: 60

  No more than N requests per minute allowed


    500 — внутренняя ошибка сервера.

Регистрация нового совершённого заказа
Хендлер: POST /api/orders.
Регистрация нового совершённого заказа. Для начисления баллов состав заказа должен быть проверен на совпадения с зарегистрированными записями вознаграждений за товары. Начисляется сумма совпадений.
Принятый заказ не обязан браться в обработку непосредственно в момент получения запроса.
Формат запроса:

POST /api/orders HTTP/1.1
Content-Type: application/json

{
    "order": "<number>",
    "goods": [
        {
            "description": "Чайник Bork",
            "price": 7000
        },
        ...
    ]
}

Поля объекта запроса:

    order — номер заказа;
    goods — список купленых товаров:

        description — наименование товара;
        price — цена оплаченного товара.

Возможные коды ответа:

    202 — заказ успешно принят в обработку;
    400 — неверный формат запроса;
    409 — заказ уже принят в обработку;
    500 — внутренняя ошибка сервера.

Регистрация информации о вознаграждении за товар
Хендлер: POST /api/goods.
Регистрация информации о вознаграждении за товар. Хендлер используется менеджерами для добавления механик вознаграждения за покупки.
Полученные системой расчёта начислений составы чеков проверяются на совпадение с зарегистрированными в данном хендлере вознаграждениями.
Механика должна иметь уникальный ключ поиска (поле match).
Формат запроса:

POST /api/goods HTTP/1.1
Content-Type: application/json

{
    "match": "Bork",
    "reward": 10,
    "reward_type": "%"
}

Поля объекта запроса:

    match — ключ поиска (проверяется на наличие в строке наименования товара), не может быть пустым;
    reward — размер вознаграждения;
    reward_type — тип вознаграждения:

        % — процент от стоимости товара;
        pt — точное количество баллов.

Возможные коды ответа:

    200 — вознаграждение успешно зарегистрировано;
    400 — неверный формат запроса;
    409 — ключ поиска уже зарегистрирован;
    500 — внутренняя ошибка сервера.

Конфигурирование сервиса накопительной системы лояльности
Сервис должен поддерживать конфигурирование следующими методами:

    адрес и порт запуска сервиса: переменная окружения ОС RUN_ADDRESS или флаг -a;
    адрес подключения к базе данных: переменная окружения ОС DATABASE_URI или флаг -d.

